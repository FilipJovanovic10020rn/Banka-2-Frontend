presubmits:
  - name: pull-banka-2-frontend-test
    labels:
      preset-github-ro-token: "true"
      preset-sonar-token: "true"
    always_run: true
    decorate: true
    spec:
      containers:
        - image: harbor.k8s.elab.rs/base-images/base:java-17-node-18-docker
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail

              start-docker.sh

              head_ref=$(curl -L --silent -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/RAF-SI-2022/"$REPO_NAME"/pulls/"$PULL_NUMBER" | jq -r .head.ref)
              export PULL_HEAD_REF="$head_ref"

              branch=$PULL_HEAD_REF
              curr_branch=$(git rev-parse --abbrev-ref HEAD)
              if [[ "$branch" == "$curr_branch" ]]; then
                branch="$PULL_HEAD_REF"-1
              fi
              git branch $branch
              git reset --hard HEAD~1
              git checkout $branch

              # Start all microservices
              docker network create --driver bridge bank2_net || true
              docker compose up -d mariadb
              docker compose up -d flyway
              docker compose up -d mongodb
              docker compose up -d users
              docker compose up -d main
              docker compose up -d otc
              
              npx cypress

          securityContext:
            privileged: true
          imagePullPolicy: Always
postsubmits:
  - name: post-banka-2-backend-otc-sonarqube
    labels:
      preset-github-ro-token: "true"
      preset-sonar-token: "true"
    always_run: true
    decorate: true
    spec:
      containers:
        - image: harbor.k8s.elab.rs/base-images/base:java-17-node-18-docker
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail

              start-docker.sh

              head_ref=$(curl -L --silent -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/RAF-SI-2022/"$REPO_NAME"/pulls/"$PULL_NUMBER" | jq -r .head.ref)
              export PULL_HEAD_REF="$head_ref"

              branch=$PULL_HEAD_REF
              curr_branch=$(git rev-parse --abbrev-ref HEAD)
              if [[ "$branch" == "$curr_branch" ]]; then
                branch="$PULL_HEAD_REF"-1
              fi
              git branch $branch
              git reset --hard HEAD~1
              git checkout $branch

              # Start all microservices
              docker network create --driver bridge bank2_net || true
              docker compose up -d mariadb
              docker compose up -d flyway
              docker compose up -d mongodb
              docker compose up -d redis
              docker compose up -d users
              docker compose up -d main
              docker compose up -d otc
              
              npm install
              npx cypress
          securityContext:
            privileged: true
          imagePullPolicy: Always